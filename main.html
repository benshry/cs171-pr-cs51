<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="js/gradesvis.js"></script>
    <script src="js/comfortvis.js"></script>
    <script src="js/classvis.js"></script>
    <script src="js/piazzavis.js"></script>

    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

</head>

<body>
    <div class="container">
        <h1>Lorem Ipsum</h1>
        <div class="row">
            <div class="col-md-8 col-sm-12">
               <p> Lorem Ipsum</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6" id="gradesVis">
              <select id="select-grades">
                <option value="midterm" selected>Midterm</option>
                <option value="ps1">Problem Set 1</option>
                <option value="ps2">Problem Set 2</option>
                <option value="ps3">Problem Set 3</option>
                <option value="ps4">Problem Set 4</option>
                <option value="ps5">Problem Set 5</option>
                <option value="ps6">Problem Set 6</option>
              </select>
            </div>
            <div class="col-md-6" id="comfortVis"></div>
        </div>

        <div class="row">
            <div class="col-md-6" id="classVis"></div>
            <div class="col-md-6" id="piazzaVis">
              <select id="select-piazza">
                <option value="views" selected>Posts Viewed</option>
                <option value="contributions">Total Contributions</option>
                <option value="questions">Questions Asked</option>
                <option value="answers">Questions Answered</option>
                <option value="days">Days Online</option>
              </select>
            </div>
        </div>
    </div>

    <script>
        $(function() {

            // Namespace
            var AllData = [];
            var MetaData = {};

            // Initialize visualization with data in AllData and MetaData
            var initVis = function() {

                // Create an eventHandler
                var MyEventHandler = new Object();

                // Instantiate all Vis Objects here
                var grades_vis = new GradesVis(d3.select("#gradesVis"), AllData, MetaData, MyEventHandler);
                var comfort_vis = new ComfortVis(d3.select("#comfortVis"), AllData, MetaData, MyEventHandler);
                var class_vis = new ClassVis(d3.select("#classVis"), AllData, MetaData);
                var piazza_vis = new PiazzaVis(d3.select("#piazzaVis"), AllData, MetaData);

                // Listen for clicks on grades visualization
                $(MyEventHandler).bind("selectionChanged", function(e, o) {
                  comfort_vis.onSelectionChange(o.id, o.min, o.max);
                  class_vis.onSelectionChange(o.id, o.min, o.max);
                  piazza_vis.onSelectionChange(o.id, o.min, o.max);
                });

                // Listen for clicks on comfort visualization
                $(MyEventHandler).bind("comfortClick", function(e, o) {
                  grades_vis.onComfortChange(o.id, o.comfort);
                  class_vis.onComfortChange(o.id, o.comfort);
                  piazza_vis.onComfortChange(o.id, o.comfort);
                });

            }

            var start = function() {

                d3.selectAll("svg").remove();

                d3.json("output/parsed.json", function(error, data) {
                    if (!error) {
                      AllData = data;
                    }
                    initVis();
                });
            }

            start();

            /* Event Handlers */
            d3.select("select#select-grades").on("change", function() {
              start();
            });

            d3.select("select#select-piazza").on("change", function() {
              start();
            });
        })

        /* isEmpty function from: http://stackoverflow.com/questions/4994201/is-object-empty */
        function isEmpty(obj) {

            var hasOwnProperty = Object.prototype.hasOwnProperty;

            // null and undefined are "empty"
            if (obj == null) return true;

            // Assume if it has a length property with a non-zero value
            // that that property is correct.
            if (obj.length > 0)    return false;
            if (obj.length === 0)  return true;

            // Otherwise, does it have any properties of its own?
            // Note that this doesn't handle
            // toString and valueOf enumeration bugs in IE < 9
            for (var key in obj) {
                if (hasOwnProperty.call(obj, key)) return false;
            }

            return true;
        }

        function multiFilter(data, filterFunctions) {
          filtered = [];
          for (item in data) {
            for (key in filterFunctions) {
              if (filterFunctions[key](data[item])) {
                filtered.push(data[item]);
                break;
              }
            }
          }
          return filtered;
        }
    </script>
</body>
</html>
